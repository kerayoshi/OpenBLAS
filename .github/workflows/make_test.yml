name: continuous build

on: [push]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

     
      - name: Install Dependencies
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get install -y gfortran
          elif [ "$RUNNER_OS" == "macOS" ]; then
            # It looks like "gfortran" isn't working correctly unless "gcc" is re-installed.
            brew reinstall gcc 
            brew install gfortran
          else
            echo "::error::$RUNNER_OS not supported"
            exit 1
          fi
      - name: Make OpenBLAS
        run: |
          make CC=cc FC=gfortran
          
      
      - name: Install OpenBLAS
        run: |
          make install PREFIX=/opt/OpenBLAS
          
      - name: Run tests
        timeout-minutes: 60
        run: |
          MAKE_FLAGS='DYNAMIC_ARCH=1 USE_OPENMP=0'
          echo "::group::Tests in 'test' directory"
          make -C test $MAKE_FLAGS FC=gfortran
          echo "::endgroup::"
          echo "::group::Tests in 'ctest' directory"
          make -C ctest $MAKE_FLAGS FC=gfortran
          echo "::endgroup::"
          echo "::group::Tests in 'utest' directory"
          make -C utest $MAKE_FLAGS FC=gfortran
          echo "::endgroup::"
           
